## 1. Lista tabel (kolumny, typy, ograniczenia)

### Użytkownicy i autentyfikacja (Lucia Auth)

- `users`
  - `id` — uuid — PK DEFAULT gen_random_uuid()
  - `email` — text — UNIQUE, NOT NULL
  - `email_verified` — boolean — NOT NULL DEFAULT false
  - `hashed_password` — text — NULL (dla hasłowych loginów)
  - `google_id` — text — UNIQUE, NULL (dla Google OAuth)
  - `is_admin` — boolean — NOT NULL DEFAULT false
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - `updated_at` — timestamptz — NOT NULL DEFAULT now()

- `user_sessions`
  - `id` — text — PK
  - `user_id` — uuid — FK → `users(id)`, ON DELETE CASCADE, NOT NULL
  - `expires_at` — timestamptz — NOT NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()

- `user_keys`
  - `id` — text — PK
  - `user_id` — uuid — FK → `users(id)`, ON DELETE CASCADE, NOT NULL
  - `hashed_password` — text — NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()

### Użytkownicy i profil

- `profiles`
  - `user_id` — uuid — PK, FK → `users(id)`, ON DELETE CASCADE, NOT NULL
  - `display_name` — text — NULL
  - `default_prep_time_bucket` — smallint — NOT NULL DEFAULT 30, CHECK (value IN (15, 30, 45, 60))
  - `accepted_terms_at` — timestamptz — NULL
  - `accepted_privacy_at` — timestamptz — NULL
  - `locale` — text — NULL, CHECK (length(locale) BETWEEN 2 AND 10)
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - `updated_at` — timestamptz — NOT NULL DEFAULT now(
- `user_diets`
  - `user_id` — uuid — FK → `profiles(user_id)`, ON DELETE CASCADE, NOT NULL
  - `diet_id` — smallint — FK → `diets(id)`, ON DELETE RESTRICT, NOT NULL
  - PK: (`user_id`, `diet_id`)

- `favorites`
  - `id` — bigserial — PK
  - `user_id` — uuid — FK → `profiles(user_id)`, ON DELETE CASCADE, NOT NULL
  - `recipe_id` — uuid — FK → `recipes(id)`, ON DELETE CASCADE, NOT NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - UNIQUE (`user_id`, `recipe_id`)

- `user_hidden_recipes`
  - `id` — bigserial — PK
  - `user_id` — uuid — FK → `profiles(user_id)`, ON DELETE CASCADE, NOT NULL
  - `recipe_id` — uuid — FK → `recipes(id)`, ON DELETE CASCADE, NOT NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - UNIQUE (`user_id`, `recipe_id`)

- `daily_picks`
  - `id` — bigserial — PK
  - `user_id` — uuid — FK → `profiles(user_id)`, ON DELETE CASCADE, NOT NULL
  - `for_date` — date — NOT NULL  (UTC doby)
  - `recipe_id` — uuid — FK → `recipes(id)`, ON DELETE SET NULL, NULL
  - `recipe_version_id` — bigint — FK → `recipe_versions(id)`, ON DELETE SET NULL, NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - UNIQUE (`user_id`, `for_date`)

- `public_shares`
  - `id` — uuid — PK DEFAULT gen_random_uuid()
  - `slug` — text — UNIQUE, NOT NULL (krótki publiczny identyfikator)
  - `user_id` — uuid — FK → `profiles(user_id)`, ON DELETE CASCADE, NOT NULL
  - `recipe_version_id` — bigint — FK → `recipe_versions(id)`, ON DELETE SET NULL, NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - `expires_at` — timestamptz — NULL
  - `is_enabled` — boolean — NOT NULL DEFAULT true

### Przepisy, wersjonowanie i składniki

- `recipes`
  - `id` — uuid — PK DEFAULT gen_random_uuid()
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - `is_blocked` — boolean — NOT NULL DEFAULT false
  - `blocked_at` — timestamptz — NULL
  - `blocked_by` — uuid — FK → `profiles(user_id)`, ON DELETE SET NULL, NULL
  - `current_version_id` — bigint — FK → `recipe_versions(id)`, ON DELETE SET NULL, NULL

- `recipe_versions` (SCD2)
  - `id` — bigint — PK GENERATED BY DEFAULT AS IDENTITY
  - `recipe_id` — uuid — FK → `recipes(id)`, ON DELETE CASCADE, NOT NULL
  - `version` — integer — NOT NULL
  - `title` — text — NOT NULL
  - `title_normalized` — text — NOT NULL
  - `instructions` — text — NULL
  - `image_url` — text — NULL
  - `prep_time_estimate` — smallint — NULL, CHECK (prep_time_estimate >= 0)
  - `quality_score` — smallint — NULL, CHECK (quality_score BETWEEN 0 AND 100)
  - `source` — text — NOT NULL  (np. 'TheMealDB')
  - `source_id` — text — NULL  (ID rekordu w źródle)
  - `valid_from` — timestamptz — NOT NULL DEFAULT now()
  - `valid_to` — timestamptz — NULL  (NULL oznacza rekord bieżący)
  - `is_current` — boolean — NOT NULL DEFAULT true
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - UNIQUE (`recipe_id`, `version`)
  - CHECK ( (is_current AND valid_to IS NULL) OR (NOT is_current AND valid_to IS NOT NULL) )

- `ingredients`
  - `id` — bigint — PK GENERATED BY DEFAULT AS IDENTITY
  - `name` — text — NOT NULL
  - `name_normalized` — text — NOT NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - UNIQUE (lower(`name`))
  - UNIQUE (lower(`name_normalized`))

- `recipe_ingredients`
  - `id` — bigint — PK GENERATED BY DEFAULT AS IDENTITY
  - `recipe_version_id` — bigint — FK → `recipe_versions(id)`, ON DELETE CASCADE, NOT NULL
  - `ingredient_id` — bigint — FK → `ingredients(id)`, ON DELETE RESTRICT, NOT NULL
  - `position` — smallint — NOT NULL DEFAULT 0
  - `measure` — text — NULL  (np. '1 cup', '2 tbsp')
  - `quantity` — numeric(10,2) — NULL
  - `unit` — text — NULL
  - UNIQUE (`recipe_version_id`, `ingredient_id`)

- `diets`
  - `id` — smallint — PK GENERATED BY DEFAULT AS IDENTITY
  - `code` — text — UNIQUE, NOT NULL  (np. 'vegetarian', 'vegan', 'gluten_free', 'lactose_free')
  - `name` — text — NOT NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()

- `recipe_diets`
  - `recipe_version_id` — bigint — FK → `recipe_versions(id)`, ON DELETE CASCADE, NOT NULL
  - `diet_id` — smallint — FK → `diets(id)`, ON DELETE RESTRICT, NOT NULL
  - PK: (`recipe_version_id`, `diet_id`)

- `attributions`
  - `id` — bigserial — PK
  - `recipe_version_id` — bigint — FK → `recipe_versions(id)`, ON DELETE CASCADE, NOT NULL
  - `source_name` — text — NOT NULL  (np. 'TheMealDB')
  - `source_url` — text — NULL
  - `source_id` — text — NULL
  - `image_source_url` — text — NULL
  - `license` — text — NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()

### Historia losowań i filtry (z TTL 30 dni)

- `draw_history` (tabela nadrzędna, partycjonowana miesięcznie po `created_at`)
  - `id` — bigserial — PK
  - `user_id` — uuid — FK → `profiles(user_id)`, ON DELETE CASCADE, NOT NULL
  - `recipe_id` — uuid — FK → `recipes(id)`, ON DELETE SET NULL, NULL
  - `recipe_version_id` — bigint — FK → `recipe_versions(id)`, ON DELETE SET NULL, NULL
  - `prep_time_bucket` — smallint — NOT NULL, CHECK (value IN (15, 30, 45, 60))
  - `session_id` — uuid — NULL  (ID sesji klienta; per karta/okno)
  - `seed` — text — NULL  (materiał losujący, dla odtwarzalności)
  - `created_at` — timestamptz — NOT NULL DEFAULT now()

- `draw_history_diets`
  - `draw_history_id` — bigint — FK → `draw_history(id)`, ON DELETE CASCADE, NOT NULL
  - `diet_id` — smallint — FK → `diets(id)`, ON DELETE RESTRICT, NOT NULL
  - PK: (`draw_history_id`, `diet_id`)

### Moderacja i zgłoszenia

- `content_reports`
  - `id` — bigserial — PK
  - `reported_by` — uuid — FK → `profiles(user_id)`, ON DELETE SET NULL, NULL
  - `recipe_id` — uuid — FK → `recipes(id)`, ON DELETE SET NULL, NULL
  - `category_id` — smallint — FK → `report_categories(id)`, ON DELETE RESTRICT, NOT NULL
  - `status_id` — smallint — FK → `report_statuses(id)`, ON DELETE RESTRICT, NOT NULL
  - `comment` — text — NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - `updated_at` — timestamptz — NOT NULL DEFAULT now()
  - `processed_by` — uuid — FK → `profiles(user_id)`, ON DELETE SET NULL, NULL
  - `processed_at` — timestamptz — NULL

- `report_categories`
  - `id` — smallint — PK GENERATED BY DEFAULT AS IDENTITY
  - `code` — text — UNIQUE, NOT NULL (np. 'bad_data', 'image_issue', 'copyright', 'other')
  - `name` — text — NOT NULL

- `report_statuses`
  - `id` — smallint — PK GENERATED BY DEFAULT AS IDENTITY
  - `code` — text — UNIQUE, NOT NULL (np. 'open', 'resolved', 'rejected')
  - `name` — text — NOT NULL

- `admin_audit`
  - `id` — bigserial — PK
  - `actor_user_id` — uuid — FK → `profiles(user_id)`, ON DELETE SET NULL, NULL
  - `target_table` — text — NOT NULL
  - `target_pk` — text — NOT NULL
  - `action` — text — NOT NULL  (np. 'block_recipe', 'edit_version', 'edit_tags')
  - `reason` — text — NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()

- `admin_audit_field_changes`
  - `id` — bigserial — PK
  - `audit_id` — bigint — FK → `admin_audit(id)`, ON DELETE CASCADE, NOT NULL
  - `column_name` — text — NOT NULL
  - `before_value` — text — NULL
  - `after_value` — text — NULL

### Import/ETL i atrybucja źródeł

- `import_batches`
  - `id` — bigserial — PK
  - `source_name` — text — NOT NULL (np. 'TheMealDB')
  - `external_batch_id` — text — NULL, UNIQUE
  - `status` — text — NOT NULL DEFAULT 'running' (np. 'running', 'completed', 'failed')
  - `started_at` — timestamptz — NOT NULL DEFAULT now()
  - `completed_at` — timestamptz — NULL
  - `inserted_count` — integer — NOT NULL DEFAULT 0
  - `updated_count` — integer — NOT NULL DEFAULT 0
  - `skipped_count` — integer — NOT NULL DEFAULT 0
  - `error_count` — integer — NOT NULL DEFAULT 0

- `source_records`
  - `id` — bigserial — PK
  - `batch_id` — bigint — FK → `import_batches(id)`, ON DELETE CASCADE, NOT NULL
  - `source_name` — text — NOT NULL
  - `external_id` — text — NOT NULL
  - `recipe_id` — uuid — FK → `recipes(id)`, ON DELETE SET NULL, NULL
  - `recipe_version_id` — bigint — FK → `recipe_versions(id)`, ON DELETE SET NULL, NULL
  - `operation` — text — NOT NULL (np. 'insert', 'update', 'skip', 'block')
  - `title_raw` — text — NULL
  - `title_normalized` — text — NULL
  - `created_at` — timestamptz — NOT NULL DEFAULT now()
  - UNIQUE (`source_name`, `external_id`)


## 2. Relacje między tabelami (kardynalność)

- `users (1)` → `profiles (1)` — 1‑1 po `profiles.user_id`
- `profiles (1)` → `favorites (N)` — 1‑N po `user_id`
- `profiles (1)` → `user_hidden_recipes (N)` — 1‑N po `user_id`
- `profiles (1)` → `user_diets (N)` — 1‑N po `user_id`
- `profiles (1)` → `draw_history (N)` — 1‑N po `user_id`
- `profiles (1)` → `daily_picks (N)` — 1‑N po `user_id`
- `profiles (1)` → `public_shares (N)` — 1‑N po `user_id`
- `profiles (1)` → `content_reports (N)` — 1‑N po `reported_by`
- `profiles (1)` → `admin_audit (N)` — 1‑N po `actor_user_id`

- `recipes (1)` → `recipe_versions (N)` — 1‑N po `recipe_id` (SCD2)
- `recipes (1)` → `favorites (N)` — 1‑N po `recipe_id`
- `recipes (1)` → `user_hidden_recipes (N)` — 1‑N po `recipe_id`
- `recipes (1)` → `draw_history (N)` — 1‑N po `recipe_id`
- `recipes (1)` → `content_reports (N)` — 1‑N po `recipe_id`
- `recipes (1)` → `source_records (N)` — 1‑N po `recipe_id`

- `recipe_versions (1)` → `recipe_ingredients (N)` — 1‑N po `recipe_version_id`
- `recipe_versions (1)` → `recipe_diets (N)` — 1‑N po `recipe_version_id`
- `recipe_versions (1)` → `attributions (N)` — 1‑N po `recipe_version_id`
- `recipe_versions (1)` → `public_shares (N)` — 1‑N po `recipe_version_id`
- `recipe_versions (1)` → `source_records (N)` — 1‑N po `recipe_version_id`

- `ingredients (1)` ↔ `recipe_ingredients (N)` — 1‑N po `ingredient_id`
- `diets (1)` ↔ `recipe_diets (N)` — 1‑N po `diet_id`
- `diets (1)` ↔ `user_diets (N)` — 1‑N po `diet_id`

- `draw_history (1)` ↔ `draw_history_diets (N)` — 1‑N po `draw_history_id`
- `report_categories (1)` ↔ `content_reports (N)` — 1‑N po `category_id`
- `report_statuses (1)` ↔ `content_reports (N)` — 1‑N po `status_id`
- `import_batches (1)` ↔ `source_records (N)` — 1‑N po `batch_id`


## 3. Indeksy (wydajność)

- `users`
  - PK on (`id`)
  - UNIQUE on (`email`)
  - UNIQUE on (`google_id`) WHERE `google_id` IS NOT NULL
  - IDX on (`is_admin`) WHERE `is_admin` = true

- `user_sessions`
  - PK on (`id`)
  - IDX on (`user_id`)
  - IDX on (`expires_at`)

- `user_keys`
  - PK on (`id`)
  - IDX on (`user_id`)

- `profiles`
  - PK on (`user_id`)

- `user_diets`
  - PK on (`user_id`, `diet_id`)
  - IDX on (`diet_id`)

- `favorites`
  - PK on (`id`)
  - UNIQUE on (`user_id`, `recipe_id`)
  - IDX on (`user_id`)

- `user_hidden_recipes`
  - PK on (`id`)
  - UNIQUE on (`user_id`, `recipe_id`)
  - IDX on (`user_id`)

- `daily_picks`
  - PK on (`id`)
  - UNIQUE on (`user_id`, `for_date`)
  - IDX on (`user_id`)

- `public_shares`
  - PK on (`id`)
  - UNIQUE on (`slug`)
  - IDX on (`recipe_version_id`)
  - IDX on (`user_id`)
  - PARTIAL IDX on (`slug`) WHERE `is_enabled` AND (`expires_at` IS NULL OR `expires_at` > now())

- `recipes`
  - PK on (`id`)
  - PARTIAL IDX on (`id`) WHERE NOT `is_blocked`
  - IDX on (`current_version_id`)

- `recipe_versions`
  - PK on (`id`)
  - UNIQUE on (`recipe_id`, `version`)
  - PARTIAL IDX on (`recipe_id`) WHERE `is_current`
  - IDX on (`title_normalized`)
  - OPTIONAL (po włączeniu rozszerzenia): GIN/GIN_trgm na (`title_normalized`) do wyszukiwania pełnotekstowego/przybliżonego

- `ingredients`
  - PK on (`id`)
  - UNIQUE on (lower(`name`))
  - UNIQUE on (lower(`name_normalized`))
  - OPTIONAL: GIN/GIN_trgm na (`name_normalized`)

- `recipe_ingredients`
  - PK on (`id`)
  - UNIQUE on (`recipe_version_id`, `ingredient_id`)
  - IDX on (`ingredient_id`)
  - IDX on (`recipe_version_id`)

- `diets`
  - PK on (`id`)
  - UNIQUE on (`code`)

- `recipe_diets`
  - PK on (`recipe_version_id`, `diet_id`)
  - IDX on (`diet_id`)

- `attributions`
  - PK on (`id`)
  - IDX on (`recipe_version_id`)

- `draw_history` (tabela nadrzędna partycjonowana)
  - PK on (`id`)
  - IDX on (`user_id`, `created_at` DESC)
  - IDX on (`user_id`, `recipe_id`, `created_at` DESC)  — szybkie wykluczanie ostatnich 20
  - PARTITIONING: RANGE (`created_at`) z miesięcznymi partycjami: `draw_history_YYYY_MM`

- `draw_history_diets`
  - PK on (`draw_history_id`, `diet_id`)
  - IDX on (`diet_id`)

- `content_reports`
  - PK on (`id`)
  - IDX on (`recipe_id`)
  - IDX on (`reported_by`)
  - IDX on (`status_id`)
  - IDX on (`created_at` DESC)

- `report_categories`
  - PK on (`id`)
  - UNIQUE on (`code`)

- `report_statuses`
  - PK on (`id`)
  - UNIQUE on (`code`)

- `admin_audit`
  - PK on (`id`)
  - IDX on (`target_table`, `target_pk`)
  - IDX on (`created_at` DESC)

- `admin_audit_field_changes`
  - PK on (`id`)
  - IDX on (`audit_id`)

- `import_batches`
  - PK on (`id`)
  - UNIQUE on (`external_batch_id`)
  - IDX on (`source_name`, `status`)
  - IDX on (`started_at` DESC)

- `source_records`
  - PK on (`id`)
  - UNIQUE on (`source_name`, `external_id`)
  - IDX on (`batch_id`)
  - IDX on (`recipe_id`)
  - IDX on (`recipe_version_id`)


## 4. Bezpieczeństwo i kontrola dostępu

### Podejście do autoryzacji
- **Poziom aplikacji**: Kontrola dostępu implementowana w kodzie aplikacji (Drizzle + Lucia Auth)
- **RLS opcjonalne**: Dla krytycznych danych można dodać RLS z kontekstem sesji
- **Admin role**: Implementacja przez flagę `is_admin` w tabeli `users` lub osobną tabelę ról

### Tabele użytkowników (chronione)
- `users`, `user_sessions`, `user_keys`
  - Dostęp tylko przez aplikację - nigdy bezpośredni dostęp z zewnątrz
  - Lucia Auth zarządza sesjami i kluczami

- `profiles`
  - Dostęp tylko dla właściciela profilu lub administratorów
  - Implementacja przez sprawdzenie `user_id = current_user_id` w aplikacji

### Tabele per-user (chronione)
- `favorites`, `user_hidden_recipes`, `user_diets`, `draw_history`, `draw_history_diets`, `daily_picks`
  - Dostęp tylko dla właściciela danych (`user_id = current_user_id`)
  - Administratorzy mają dostęp do wszystkich rekordów

### Tabele publiczne (częściowo chronione)
- `recipes`, `recipe_versions`, `ingredients`, `diets`, `recipe_ingredients`, `recipe_diets`, `attributions`
  - Publiczny SELECT dla aktywnych, nie zablokowanych przepisów
  - Modyfikacje tylko przez administratorów lub proces ETL
  - Filtry: `NOT is_blocked` dla recipes, `is_current` dla recipe_versions

- `public_shares`
  - Publiczny SELECT dla aktywnych udostępnień (bez uwierzytelniania)
  - Warunki: `is_enabled AND (expires_at IS NULL OR expires_at > now())`
  - Właściciel może zarządzać własnymi udostępnieniami

### Tabele moderacji i zgłoszeń
- `content_reports`, `report_categories`, `report_statuses`
  - Użytkownicy mogą tworzyć własne zgłoszenia i przeglądać swoje
  - Administratorzy mają pełny dostęp do wszystkich zgłoszeń

### Import/ETL i audyt (tylko admin)
- `import_batches`, `source_records`, `admin_audit`, `admin_audit_field_changes`
  - Dostęp tylko dla administratorów i procesów ETL
  - Śledzenie wszystkich zmian administracyjnych


## 5. Dodatkowe uwagi projektowe

- **SCD2 dla przepisów**: `recipe_versions` utrzymuje historię z `valid_from/valid_to` i `is_current`. Wymuszona unikalność (`recipe_id`, `version`) oraz spójność przez CHECK. `recipes.current_version_id` służy do szybkich joinów (spójność z `is_current` utrzymywana po stronie serwisu/aplikacji lub triggerem).
- **Filtry dieta/czas**: filtrowanie po diecie realizowane przez `recipe_diets`, po czasie przez predykat `prep_time_estimate` oraz/bądź `prep_time_bucket` po stronie klienta. Indeksy częściowe i złożone umożliwiają szybkie zapytania.
- **Wykluczanie ostatnich wyników**: zapytanie korzysta z indeksu (`user_id`, `recipe_id`, `created_at DESC`) w `draw_history`, ograniczenie do TOP 20.
- **Partycjonowanie i TTL**: `draw_history` partycjonowana miesięcznie po `created_at`. TTL 30 dni realizowany zadaniem harmonogramu (np. cron) usuwającym partycje starsze niż 1 miesiąc + 0 dni.
- **Moderacja**: blokada przepisu przez `recipes.is_blocked`; publiczne SELECTy respektują blokady (RLS). Zablokowane przepisy nie są ujawniane w udostępnieniach.
- **Atrybucja**: `attributions` na poziomie `recipe_version_id` spełnia wymóg licencyjny i audytowalność zmian.
- **Import i idempotencja**: `source_records` z unikalnością (`source_name`, `external_id`) umożliwia idempotentny import/aktualizację oraz śledzenie decyzji (`operation`).
- **Słowniki**: `diets`, `report_categories`, `report_statuses` to słowniki. Zalecane pre‑seed wartości minimalne: diety [vegetarian, vegan, gluten_free, lactose_free]; statusy [open, resolved, rejected].
- **Wyszukiwanie tytułów**: opcjonalnie rozszerzenie `pg_trgm` + indeks GIN/GIN_trgm na `recipe_versions.title_normalized` i `ingredients.name_normalized` dla wyszukiwarki. MVP może pominąć, dodać później.
- **Spójność `public_shares`**: przy usunięciu/przebudowie wersji przepisu, FK `recipe_version_id` pozostawione jako NULL i `is_enabled` może być dezaktywowane po stronie serwisowej.
- **Zgodność z RODO**: PII ograniczone do tabel `users` i `profiles`; pozostałe tabele unikają e‑maili i danych osobowych. Kontrola dostępu na poziomie aplikacji zapewnia izolację rekordów per‑user.
- **Indeksy częściowe**: `recipes` i `recipe_versions` używają indeksów częściowych pod typowe predykaty (NOT blocked, is_current). To minimalizuje rozmiar indeksów i poprawia selektywność.


